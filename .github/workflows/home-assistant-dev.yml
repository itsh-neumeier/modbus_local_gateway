name: Validate against Home Assistant dev

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Get latest Home Assistant dev commit
        id: hass
        run: |
          LATEST="$(git ls-remote https://github.com/home-assistant/core.git refs/heads/dev | cut -f1)"
          echo "latest=$LATEST" >> "$GITHUB_OUTPUT"
          echo "Home Assistant dev commit: $LATEST" >> "$GITHUB_STEP_SUMMARY"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.14"

      - name: Install dependencies against Home Assistant dev
        run: |
          python -m pip install --upgrade pip
          python - <<'PY'
          from pathlib import Path

          source = Path("requirements_dev.txt")
          target = Path("requirements_dev_ha_dev.txt")
          latest = "${{ steps.hass.outputs.latest }}"

          lines = source.read_text(encoding="utf-8").splitlines()
          with target.open("w", encoding="utf-8") as out:
              for line in lines:
                  if line.strip().startswith("homeassistant=="):
                      out.write(f"git+https://github.com/home-assistant/core.git@{latest}\n")
                  else:
                      out.write(f"{line}\n")
          PY
          pip install -r requirements.txt -r requirements_dev_ha_dev.txt

      - name: Run lint checks
        run: |
          isort --check-only --diff .
          ruff format --check .
          ruff check .

      - name: Run unit tests
        run: pytest --cov=. --cov-config=.coveragerc --cov-report xml:coverage.xml

      - name: Validate with hassfest
        uses: home-assistant/actions/hassfest@master

      - name: Validate with HACS
        uses: hacs/action@main
        with:
          category: integration
          ignore: wheels

      - name: Open or update failure issue
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = "Home Assistant dev validation is failing";
            const label = "ha-dev-validation";
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
            const latest = "${{ steps.hass.outputs.latest }}";

            const { data: labels } = await github.rest.issues.listLabelsOnRepo({ owner, repo, per_page: 100 });
            if (!labels.some((item) => item.name === label)) {
              await github.rest.issues.createLabel({
                owner,
                repo,
                name: label,
                color: "d73a4a",
                description: "Tracking failures in HA dev compatibility workflow",
              });
            }

            const { data: existing } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              labels: label,
              per_page: 100,
            });

            const issue = existing.find((item) => item.title === title);
            const body = [
              "Nightly validation against Home Assistant dev failed.",
              "",
              `- Home Assistant dev commit: ${latest}`,
              `- Workflow run: ${runUrl}`,
              "",
              "Please review the failed checks and update the integration if needed.",
            ].join("\n");

            if (issue) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body,
              });
              core.info(`Updated existing issue #${issue.number}`);
            } else {
              const created = await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: [label],
              });
              core.info(`Created issue #${created.data.number}`);
            }

      - name: Close failure issue on recovery
        if: success()
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = "Home Assistant dev validation is failing";
            const label = "ha-dev-validation";
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;

            const { data: existing } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              labels: label,
              per_page: 100,
            });

            const issue = existing.find((item) => item.title === title);
            if (!issue) {
              core.info("No open failure issue to close");
              return;
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body: `Validation is passing again. Closing via run ${runUrl}`,
            });

            await github.rest.issues.update({
              owner,
              repo,
              issue_number: issue.number,
              state: "closed",
            });

            core.info(`Closed issue #${issue.number}`);
